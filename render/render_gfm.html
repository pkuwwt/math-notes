<!DOCTYPE html>
<html>
	<head>
		  <meta charset="utf-8"/>
		  <title>Rendering Github Flavored Markdown</title>
		  <script src="marked.min.js"></script>
		  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" integrity="sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0" crossorigin="anonymous"> 
		  <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js" integrity="sha384-/y1Nn9+QQAipbNQWU65krzJralCnuOasHncUFXGkdwntGeSvQicrYkiUBwsgUqc1" crossorigin="anonymous"></script> 
		  <script src="https://code.jquery.com/jquery-1.12.4.js"></script> 
		  <script>
marked.setOptions({
	renderer: new marked.Renderer(),
	gfm: true,
	tables: true,
	breaks: false,
	pedantic: false,
	sanitize: false,
	smartLists: true,
	smartypants: false
});
var getURLParameter = function(name) {
	  return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) || [null, ''])[1].replace(/\+/g, '%20')) || null;
}
var get_markdown_file = function() {
	return getURLParameter("file");
};
var get_location = function(href) {
	var l = document.createElement("a");
	l.href = href;
	return l;
};
var get_absolute_url = function(rel_path) {
	if(rel_path==null) return null;
	var href = get_location(window.location.href);
	var pathname = href.pathname;
	//console.log(href.pathname);
	var dirname = pathname.substring(0, pathname.lastIndexOf('/'));
	return href.protocol + "//" + href.hostname + ":" + href.port + "/" + dirname + "/" + rel_path;
};
function readTextFile(file,callback)
{
	if(file==null) {
		return callback("");
	}
    var rawFile = new XMLHttpRequest();
    rawFile.open("GET", file, false);
    rawFile.onreadystatechange = function ()
    {
        if(rawFile.readyState === 4)
        {
            if(rawFile.status === 200 || rawFile.status == 0)
            {
                var allText = rawFile.responseText;
                callback(allText);
            }
        }
    }
    rawFile.send(null);
}
var handle_inline_math = function(html) {
	var obj = $("<div>" + html + "</div>");
	obj.find("code:not([class])").replaceWith(function() { 
		var tex = $(this).text(); 
		if(tex.length==0) return tex;
		if(tex[0]=='$' && tex[tex.length-1]=='$') {
			tex = tex.substr(1,tex.length-2);
			return katex.renderToString(tex, {displayMode: false}); 
		}
		else {
			return tex;
		}
	}); 
	return obj.html();
};
var handle_display_math = function(html) {
	var obj = $("<div>" + html + "</div>");
	obj.find("code[class='lang-math']").replaceWith(function() { 
		var html = $(this).html(); 
		html = html.replace(/amp;/g, ''); // a bug of marked: parsing & to &amp;
		return katex.renderToString(html.replace(/%.*/g, ''), {displayMode: true}); 
	}); 
	return obj.html();
};
var handle_katex_synatx = function(text) {
	//TODO
	return text;
};
var main = function(callback) {
	var file = get_markdown_file();
	var url = get_absolute_url(file);
	readTextFile(url, function(text) {
		if(text=="") return callback("");
		text = handle_katex_synatx(text);
		var html = marked(text);
		html = handle_inline_math(html);
		html = handle_display_math(html);
		//console.log('---', html);
		callback(html);
	});
};
		  </script>
	</head>
	<body>
		<div id="content"></div>
		<script>
main(function(html) { document.getElementById('content').innerHTML = html; });
		</script>
	</body>
</html>

